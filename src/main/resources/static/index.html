<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AtmosFlux ¬∑ Weather Intelligence Console</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-2: #0f172a;
      --panel: rgba(15, 23, 42, 0.88);
      --border: rgba(148, 163, 184, 0.25);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.22);
      --accent-strong: #0ea5e9;
      --accent-glow: #c084fc;
      --text: #e2e8f0;
      --text-soft: #94a3b8;
      --card-shadow: 0 24px 60px rgba(15, 23, 42, 0.55);
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(800px 600px at 110% 0%, rgba(192, 132, 252, 0.2), transparent 55%),
        var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    a { color: inherit; }

    .container { width: min(1200px, 92vw); margin: 2.5rem auto 4rem; display: flex; flex-direction: column; gap: 2rem; }

    .navbar { position: sticky; top: 1.2rem; z-index: 20; width: min(1200px, 92vw); margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: .85rem 1.4rem; border-radius: 22px; border: 1px solid rgba(148,163,184,0.25); background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 64, 175, 0.65)); backdrop-filter: blur(16px); box-shadow: 0 22px 44px rgba(2, 6, 23, 0.55); }
    .brand { font-weight: 700; letter-spacing: .28em; text-transform: uppercase; font-size: .8rem; color: rgba(226,232,240,0.9); display: flex; align-items: center; gap: .55rem; }
    .brand::before { content: ""; width: 12px; height: 12px; border-radius: 50%; background: radial-gradient(circle, var(--accent), rgba(14, 165, 233, 0)); box-shadow: 0 0 16px rgba(14, 165, 233, 0.85); }
    .nav-links { display: flex; align-items: center; gap: 1rem; font-size: .85rem; color: var(--text-soft); }
    .nav-links a { color: inherit; opacity: .82; text-decoration: none; transition: opacity .2s; }
    .nav-links a:hover { opacity: 1; }
    .nav-cta { border: 1px solid rgba(14,165,233,0.55); background: linear-gradient(135deg, rgba(56,189,248,0.25), rgba(192,132,252,0.2)); color: #fff; border-radius: 16px; padding: .55rem 1.1rem; font-size: .82rem; letter-spacing: .08em; text-transform: uppercase; display: inline-flex; align-items: center; gap: .4rem; transition: transform .2s, box-shadow .2s; }
    .nav-cta:hover { background: linear-gradient(135deg, rgba(14,165,233,0.4), rgba(192,132,252,0.28)); box-shadow: 0 10px 24px rgba(14, 165, 233, 0.35); transform: translateY(-1px); }


    header.hero { position: relative; overflow: hidden; border-radius: 32px; padding: clamp(2rem, 5vw, 3rem); background: linear-gradient(135deg, rgba(14, 165, 233, .72), rgba(99, 102, 241, .55)); box-shadow: 0 40px 80px rgba(15, 23, 42, 0.45); display: grid; gap: 1.2rem; }
    header.hero::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at top right, rgba(255,255,255,0.55), transparent 55%); opacity: 0.55; pointer-events: none; }
    header.hero::before { content: ""; position: absolute; width: 220px; height: 220px; border-radius: 50%; top: -80px; left: -70px; background: radial-gradient(circle, rgba(99, 102, 241, 0.8), rgba(14, 165, 233, 0)); filter: blur(10px); opacity: 0.6; }
    header .badge { z-index: 1; align-self: flex-start; display: inline-flex; gap: .6rem; align-items: center; padding: .45rem .95rem; border-radius: 999px; background: rgba(15, 23, 42, .42); letter-spacing: .18em; text-transform: uppercase; font-size: .82rem; font-weight: 600; }
    header h1 { z-index: 1; margin: 0; font-size: clamp(2.3rem, 4vw, 3.2rem); line-height: 1.08; }
    header p { z-index: 1; max-width: 65ch; font-size: 1rem; color: rgba(226, 232, 240, 0.88); }
    .hero-pills { z-index:1; display:flex; flex-wrap:wrap; gap:.75rem; margin-top:.4rem; }
    .hero-pill { display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .9rem; border-radius:16px; border:1px solid rgba(255,255,255,0.28); background: rgba(15,23,42,0.35); font-size:.78rem; letter-spacing:.08em; text-transform:uppercase; color:rgba(226,232,240,0.85); }

    .stats-bar { z-index: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; }
    .stat { padding: 1rem 1.2rem; border-radius: 20px; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(255,255,255,0.22); display: grid; gap: .35rem; font-size: .86rem; color: rgba(226, 232, 240, 0.78); }
    .stat strong { font-size: 1.4rem; color: white; }

    main.layout { position: relative; display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .energy-radar { position: absolute; top: -140px; right: -90px; width: 260px; height: 260px; background: radial-gradient(circle at center, rgba(96, 165, 250, 0.45), rgba(14, 116, 144, 0)); filter: blur(55px); opacity: .55; pointer-events: none; }

    .panel { background: var(--panel); border-radius: 26px; border: 1px solid var(--border); padding: 1.8rem; box-shadow: var(--card-shadow); display: grid; gap: 1.1rem; backdrop-filter: blur(28px); }
    .panel h2 { margin: 0; font-size: 1.25rem; }
    .panel p.meta { margin: 0; font-size: .88rem; color: var(--text-soft); }

    .meteo-header { display: flex; justify-content: space-between; align-items: center; }
    .meteo-hero { display: flex; flex-direction: column; gap: .3rem; }
    .meteo-hero span { font-size: .85rem; letter-spacing: .12em; text-transform: uppercase; color: var(--text-soft); }
    .meteo-hero strong { font-size: 1.6rem; color: var(--text); }
    .headline-pulse { animation: headlinePulse .9s ease; }
    @keyframes headlinePulse {
      0% { text-shadow: 0 0 0 rgba(56, 189, 248, 0.2); }
      50% { text-shadow: 0 0 22px rgba(192, 132, 252, 0.65); }
      100% { text-shadow: 0 0 0 rgba(56, 189, 248, 0); }
    }
    .meteo-output { display: grid; gap: 1.1rem; }
    .meteo-highlights { display: grid; gap: .9rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .meteo-highlight { display: flex; gap: .85rem; align-items: center; border-radius: 20px; padding: .85rem 1rem; background: rgba(59,130,246,0.12); border: 1px solid rgba(59,130,246,0.25); box-shadow: inset 0 1px 0 rgba(255,255,255,0.08); }
    .meteo-highlight span { font-size: .75rem; letter-spacing: .14em; text-transform: uppercase; color: rgba(226,232,240,0.7); }
    .meteo-highlight strong { font-size: 1.18rem; color: var(--text); display: block; }
    .meteo-icon { width: 42px; height: 42px; border-radius: 14px; display: grid; place-items: center; background: rgba(15,23,42,0.45); font-size: 1.3rem; color: var(--accent-strong); }
    .meteo-details { margin-top: 1rem; display: grid; gap: .75rem; font-size: .95rem; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
    .meteo-detail { border-radius: 18px; padding: .85rem 1rem; background: rgba(148, 163, 184, 0.06); border: 1px solid rgba(148, 163, 184, 0.12); display: grid; gap: .4rem; position: relative; overflow: hidden; }
    .meteo-detail::after { content: ""; position: absolute; inset: 0; background: linear-gradient(145deg, rgba(96,165,250,0.18), transparent 60%); opacity: 0.35; pointer-events: none; }
    .meteo-detail span { font-size: .78rem; letter-spacing: .1em; text-transform: uppercase; color: var(--text-soft); }
    .meteo-detail strong { font-size: 1.08rem; color: var(--text); }

    form.note-form { display: grid; gap: 1rem; }
    label.field { display: grid; gap: .4rem; font-size: .85rem; text-transform: uppercase; letter-spacing: .09em; color: var(--text-soft); }
    input, textarea, select { font: inherit; color: var(--text); background: rgba(15, 23, 42, 0.55); border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 16px; padding: .75rem .95rem; transition: border-color .2s, background .2s; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: rgba(96, 165, 250, 0.7); background: rgba(15, 23, 42, 0.75); }
    textarea { resize: vertical; min-height: 120px; }

    .actions { display: flex; gap: .75rem; flex-wrap: wrap; }
    button { font: inherit; cursor: pointer; border-radius: 16px; padding: .65rem 1.1rem; border: 1px solid transparent; transition: transform .15s, box-shadow .15s, background .15s; display: inline-flex; align-items: center; gap: .4rem; }
    button.primary { background: var(--accent); color: #fff; }
    button.primary:hover { background: var(--accent-strong); }
    button.secondary { background: rgba(148, 163, 184, 0.18); border-color: rgba(148, 163, 184, 0.35); color: var(--text); }
    button.secondary:hover { background: rgba(148, 163, 184, 0.32); }
    button.ghost { background: transparent; border-color: rgba(148, 163, 184, 0.25); color: var(--text-soft); }
    button.ghost:hover { border-color: rgba(226, 232, 240, 0.5); color: var(--text); }

    section.notes-board { display: grid; gap: 1.2rem; }
    .board-header { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between; }
    .filters { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; }

    ul.notes-list { list-style: none; margin: 0; padding: 0; display: grid; gap: 1.1rem; }
    .note-card { border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 22px; background: rgba(15, 23, 42, 0.65); padding: 1.3rem 1.5rem; display: grid; gap: .75rem; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4); }
    .note-card header { display: flex; flex-wrap: wrap; gap: .75rem; align-items: baseline; justify-content: space-between; }
    .note-title { font-size: 1.2rem; font-weight: 600; }
    .note-meta { font-size: .78rem; letter-spacing: .08em; text-transform: uppercase; color: var(--text-soft); }
    .note-content { font-size: .95rem; color: rgba(226, 232, 240, 0.85); white-space: pre-wrap; }

    .resource-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .resource-card { position: relative; padding: 1.2rem 1.3rem; border-radius: 22px; border: 1px solid rgba(148, 163, 184, 0.25); background: linear-gradient(145deg, rgba(15, 23, 42, 0.75), rgba(30, 64, 175, 0.55)); box-shadow: 0 18px 38px rgba(15, 23, 42, 0.45); display: grid; gap: .6rem; min-height: 160px; }
    .resource-card::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.25), transparent 60%); opacity: .6; pointer-events: none; }
    .resource-card h3 { margin: 0; font-size: 1.08rem; color: #fff; }
    .resource-card p { margin: 0; font-size: .9rem; color: rgba(226, 232, 240, 0.78); max-width: 32ch; }
    .resource-card a { font-size: .85rem; color: var(--accent-strong); text-decoration: none; display: inline-flex; align-items: center; gap: .35rem; font-weight: 600; letter-spacing: .05em; text-transform: uppercase; }
    .resource-chip { display: inline-flex; align-items: center; gap: .35rem; padding: .3rem .7rem; border-radius: 999px; background: rgba(148, 163, 184, 0.18); border: 1px solid rgba(148, 163, 184, 0.3); font-size: .75rem; letter-spacing: .08em; text-transform: uppercase; color: rgba(226, 232, 240, 0.75); }

    .empty { display: grid; place-items: center; padding: 2.5rem 1rem; border-radius: 20px; border: 1px dashed rgba(148,163,184,0.3); color: var(--text-soft); background: rgba(15, 23, 42, 0.45); }

    .toast { position: fixed; top: 2rem; right: 2rem; padding: 1rem 1.2rem; border-radius: 18px; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--accent); color: var(--text); box-shadow: 0 18px 30px rgba(15, 23, 42, 0.55); opacity: 0; transform: translateY(-20px); transition: opacity .25s, transform .25s; pointer-events: none; }
    .toast.show { opacity: 1; transform: translateY(0); }

    dialog.modal { border: none; border-radius: 26px; padding: 0; background: transparent; }
    dialog.modal::backdrop { background: rgba(2, 6, 23, 0.75); backdrop-filter: blur(18px); }
    .modal-body { background: var(--panel); border: 1px solid var(--border); border-radius: 26px; padding: 2rem; width: min(520px, 90vw); box-shadow: var(--card-shadow); display: grid; gap: 1.2rem; }
    .modal-actions { display: flex; justify-content: flex-end; gap: .75rem; }

    footer { text-align: center; font-size: .85rem; color: var(--text-soft); padding-bottom: 2rem; }

    @media (max-width: 640px) {
      .navbar { flex-wrap: wrap; gap: .75rem; justify-content: center; }
      .nav-links { flex-wrap: wrap; justify-content: center; }
      header.hero { padding: 1.8rem; }
      .board-header { flex-direction: column; align-items: stretch; }
      .filters { width: 100%; justify-content: stretch; }
      .filters > * { flex: 1 1 auto; }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="brand">ATMOSFLUX</div>
    <div class="nav-links">
      <a href="#weatherPanel">Weather</a>
      <a href="#notesBoard">Notes</a>
      <a href="#resources">Resources</a>
      <a href="/swagger-ui/index.html" target="_blank">API</a>
    </div>
    <button class="nav-cta" id="livePulse" type="button">Pulse AI</button>
  </div>

  <div class="container">
    <header class="hero">
      <span class="badge">ATMOSFLUX ¬∑ WEATHER OPS CONSOLE</span>
      <h1>Command the climate feed and unlock sharper decision notes.</h1>
      <p>Get an instant view of the simulated weather feed, capture insights that matter, and pilot your Spring Boot experiments through an elevated operations dashboard.</p>
      <div class="hero-pills">
        <span class="hero-pill">Real-time mock API</span>
        <span class="hero-pill">Insight-driven notes</span>
        <span class="hero-pill">Scenario lab ready</span>
      </div>
      <div class="stats-bar">
        <div class="stat" data-summary="notes">
          <span>Active notes</span>
          <strong>‚Äî</strong>
          <small>Live counter</small>
        </div>
        <div class="stat" data-summary="last-update">
          <span>Latest update</span>
          <strong>‚Äî</strong>
          <small>Last note activity</small>
        </div>
        <div class="stat" data-summary="temperature">
          <span>Temperature</span>
          <strong>‚Äî</strong>
          <small>Weather snapshot</small>
        </div>
        <div class="stat" data-summary="condition">
          <span>Condition</span>
          <strong>‚Äî</strong>
          <small>Atmospheric quality</small>
        </div>
      </div>
    </header>

    <main class="layout">
      <div class="energy-radar"></div>
      <section class="panel" id="weatherPanel">
        <div class="meteo-header">
          <div class="meteo-hero">
            <span>Weather briefing</span>
            <strong id="weatherHeadline">Syncing data‚Ä¶</strong>
          </div>
          <button id="reloadWeather" class="ghost" type="button">Refresh</button>
        </div>
        <div id="weather" class="meteo-output">Loading‚Ä¶</div>
      </section>

      <section class="panel">
        <h2>Create a note</h2>
        <p class="meta">Capture field observations, weather KPIs or next steps. Title is required.</p>
        <form id="form" class="note-form">
          <label class="field">
            Title
            <input id="titre" name="titre" maxlength="200" required placeholder="e.g. Morning stand-up recap" />
          </label>
          <label class="field">
            Content
            <textarea id="contenu" name="contenu" placeholder="Add context, figures, links‚Ä¶"></textarea>
          </label>
          <div class="actions">
            <button type="submit" class="primary">Publish note</button>
            <button type="reset" class="secondary">Clear</button>
          </div>
        </form>
      </section>
    </main>

    <section class="panel" id="notesBoard" style="padding: 1.5rem; position: relative; overflow:hidden;">
      <div style="position:absolute; inset:0; background: radial-gradient(circle at bottom right, rgba(147, 51, 234, 0.15), transparent 58%); pointer-events:none;"></div>
      <section class="notes-board" style="position:relative;">
        <div class="board-header">
          <h2>Saved notes</h2>
          <div class="filters">
            <input type="search" id="searchNotes" placeholder="Search a note" />
            <select id="sortNotes" aria-label="Sort notes">
              <option value="latest">Newest first</option>
              <option value="oldest">Oldest first</option>
              <option value="title">Title A-Z</option>
            </select>
            <button type="button" id="refreshNotes" class="ghost">Reload</button>
            <button type="button" id="exportNotes" class="secondary">Export JSON</button>
          </div>
        </div>
        <ul class="notes-list" id="notes"></ul>
      </section>
    </section>

    <section class="panel" id="resources">
      <h2>Operations toolkit</h2>
      <p class="meta">Bring the demo to life with the endpoints and rituals that power AtmosFlux.</p>
      <div class="resource-grid">
        <article class="resource-card">
          <span class="resource-chip">API</span>
          <h3>Weather endpoint</h3>
          <p>Call the `/meteo` endpoint to retrieve the simulated daily weather payload powering the console.</p>
          <a href="/meteo" target="_blank" rel="noopener">Open live response ‚Üí</a>
        </article>
        <article class="resource-card">
          <span class="resource-chip">NOTES</span>
          <h3>Insights archive</h3>
          <p>Persist and curate mission notes via `/notes`. Perfect for integration tests or Postman collections.</p>
          <a href="/notes" target="_blank" rel="noopener">Browse collection ‚Üí</a>
        </article>
        <article class="resource-card">
          <span class="resource-chip">DEV FLOW</span>
          <h3>Extend the playbook</h3>
          <p>Pair this UI with your Spring Boot profiles, swap the datasource, or plug in real telemetry.</p>
          <a href="https://spring.io/projects/spring-boot" target="_blank" rel="noopener">Spring Boot guides ‚Üí</a>
        </article>
      </div>
    </section>

    <footer>
      Powered by Spring Boot 3 ‚Äì Explore <a href="/swagger-ui/index.html">Swagger UI</a> and <a href="/actuator">Actuator</a>. ¬© <span id="year"></span> AtmosFlux.
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <dialog class="modal" id="noteModal">
    <div class="modal-body">
      <header style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Edit note</h2>
        <button type="button" id="modalClose" class="ghost">Close</button>
      </header>
      <form id="modalForm" class="note-form">
        <input type="hidden" id="modalId" />
        <label class="field">
          Title
          <input id="modalTitre" maxlength="200" required />
        </label>
        <label class="field">
          Content
          <textarea id="modalContenu"></textarea>
        </label>
        <div class="modal-actions">
          <button type="button" id="modalDelete" class="ghost">Delete</button>
          <button type="submit" class="primary">Save</button>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    const weatherBox = document.getElementById('weather');
    const weatherHeadline = document.getElementById('weatherHeadline');
    const notesList = document.getElementById('notes');
    const searchInput = document.getElementById('searchNotes');
    const sortSelect = document.getElementById('sortNotes');
    const toast = document.getElementById('toast');
    const modal = document.getElementById('noteModal');
    const modalForm = document.getElementById('modalForm');
    const modalId = document.getElementById('modalId');
    const modalTitre = document.getElementById('modalTitre');
    const modalContenu = document.getElementById('modalContenu');
    const modalDelete = document.getElementById('modalDelete');
    const livePulse = document.getElementById('livePulse');

    document.getElementById('year').textContent = new Date().getFullYear();

    const summaryEls = {
      notes: document.querySelector('[data-summary="notes"] strong'),
      lastUpdate: document.querySelector('[data-summary="last-update"] strong'),
      temperature: document.querySelector('[data-summary="temperature"] strong'),
      condition: document.querySelector('[data-summary="condition"] strong')
    };

    let notesData = [];
    let filteredNotes = [];

    const formatDateTime = (iso) => {
      if (!iso) return '‚Äî';
      const d = new Date(iso);
      return new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium', timeStyle: 'short' }).format(d);
    };

    const escapeHTML = (str = '') => str.replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]));

    async function getJSON(url, options) {
      const response = await fetch(url, options);
      if (!response.ok) {
        const message = await response.text();
        throw new Error(`${response.status} ${response.statusText}${message ? ` ‚Äî ${message}` : ''}`);
      }
      return response.json();
    }

    function showToast(message, variant = 'info') {
      toast.textContent = message;
      toast.style.borderColor = variant === 'error' ? '#f87171' : 'var(--accent)';
      toast.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => toast.classList.remove('show'), 2600);
    }

    const describeWeatherMood = (data) => {
      const temperature = data.temperature_c;
      const condition = (data.condition || '').toLowerCase();
      const humidity = data.humidite_pct;
      const vibe = [];
      if (/(orage|storm)/.test(condition)) vibe.push('prepare an indoor-friendly contingency plan');
      if (/(pluie|rain)/.test(condition)) vibe.push('keep umbrellas close and pair it with upbeat messaging');
      if (/(soleil|sun)/.test(condition)) vibe.push('leverage the energy boost for strategic work');
      if (/(neige|snow)/.test(condition)) vibe.push('expect slower pace and add warmer check-ins');
      if (temperature >= 26) vibe.push('hydrate the crew and lighten the agenda');
      if (temperature <= 8) vibe.push('keep interactions cosy and focused');
      if (humidity > 70) vibe.push('watch for dips in focus and add micro-breaks');
      if (!vibe.length) vibe.push('stable outlook ‚Äì perfect window for idea sprints');
      return vibe.join(' ¬∑ ');
    };

    const capitalize = (str = '') => str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    const capitalizeWords = (str = '') => str.replace(/\p{L}+/gu, (word) => word.charAt(0).toUpperCase() + word.slice(1));

    const getConditionIcon = (condition = '') => {
      const c = condition.toLowerCase();
      if (c.includes('orage') || c.includes('storm') || c.includes('thunder')) return '‚õàÔ∏è';
      if (c.includes('pluie') || c.includes('rain')) return 'üåßÔ∏è';
      if (c.includes('neige') || c.includes('snow')) return '‚ùÑÔ∏è';
      if (c.includes('soleil') || c.includes('sun')) return '‚òÄÔ∏è';
      if (c.includes('nuage') || c.includes('couvert') || c.includes('cloud')) return '‚òÅÔ∏è';
      return 'üå§Ô∏è';
    };

    async function loadWeather() {
      weatherBox.textContent = 'Loading‚Ä¶';
      try {
        const data = await getJSON('/meteo');
        const conditionLabel = capitalizeWords(data.condition || '');
        const icon = getConditionIcon(data.condition);
        const headline = `${icon} ${escapeHTML(data.ville)} ¬∑ ${conditionLabel} ¬∑ ${data.temperature_c}¬∞C`;
        weatherHeadline.textContent = headline;
        const insight = describeWeatherMood(data);
        weatherBox.innerHTML = `
          <div class="meteo-highlights">
            <div class="meteo-highlight">
              <div class="meteo-icon">üìç</div>
              <div><span>City</span><strong>${escapeHTML(data.ville)}</strong></div>
            </div>
            <div class="meteo-highlight">
              <div class="meteo-icon">${icon}</div>
              <div><span>Condition</span><strong>${conditionLabel}</strong></div>
            </div>
            <div class="meteo-highlight">
              <div class="meteo-icon">üå°Ô∏è</div>
              <div><span>Temperature</span><strong>${data.temperature_c}&nbsp;¬∞C</strong></div>
            </div>
          </div>
          <div class="meteo-details">
            <div class="meteo-detail"><span>Date</span><strong>${escapeHTML(data.date)}</strong></div>
            <div class="meteo-detail"><span>Humidity</span><strong>${data.humidite_pct}&nbsp;%</strong></div>
            <div class="meteo-detail"><span>AI Insight</span><strong>${escapeHTML(insight)}</strong></div>
          </div>`;
        summaryEls.temperature.textContent = `${data.temperature_c} ¬∞C`;
        summaryEls.condition.textContent = conditionLabel;
      } catch (error) {
        weatherHeadline.textContent = 'Unable to retrieve weather data';
        weatherBox.innerHTML = `<span style="color:#f87171">Weather error: ${escapeHTML(error.message)}</span>`;
        summaryEls.temperature.textContent = '‚Äî';
        summaryEls.condition.textContent = '‚Äî';
      }
    }

    function updateSummary() {
      summaryEls.notes.textContent = notesData.length;
      const last = notesData.reduce((max, note) =>
        (!max || new Date(note.updatedAt) > new Date(max.updatedAt)) ? note : max, null);
      summaryEls.lastUpdate.textContent = last ? formatDateTime(last.updatedAt) : '‚Äî';
    }

    function applyFilters() {
      const query = searchInput.value.trim().toLowerCase();
      filteredNotes = notesData.filter(note => {
        if (!query) return true;
        return note.titre.toLowerCase().includes(query) || (note.contenu || '').toLowerCase().includes(query);
      });
      switch (sortSelect.value) {
        case 'oldest':
          filteredNotes.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
          break;
        case 'title':
          filteredNotes.sort((a, b) => a.titre.localeCompare(b.titre));
          break;
        default:
          filteredNotes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      }
      renderNotes();
    }

    function renderNotes() {
      if (!filteredNotes.length) {
        notesList.innerHTML = '<li class="empty">No notes to display. Create your first note or adjust the filters.</li>';
        return;
      }
      notesList.innerHTML = '';
      for (const note of filteredNotes) {
        const li = document.createElement('li');
        li.className = 'note-card';
        li.innerHTML = `
          <header>
            <span class="note-title">${escapeHTML(note.titre)}</span>
            <span class="note-meta">Created ${formatDateTime(note.createdAt)} ¬∑ Updated ${formatDateTime(note.updatedAt)}</span>
          </header>
          <p class="note-content">${escapeHTML(note.contenu || '‚Äî')}</p>
          <div class="actions">
            <button type="button" class="secondary" data-action="edit" data-id="${note.id}">Edit</button>
            <button type="button" class="ghost" data-action="delete" data-id="${note.id}">Delete</button>
          </div>`;
        li.querySelector('[data-action="edit"]').onclick = () => openEditor(note.id);
        li.querySelector('[data-action="delete"]').onclick = () => deleteNote(note.id);
        notesList.appendChild(li);
      }
    }

    async function loadNotes(silent = false) {
      if (!silent) {
        notesList.innerHTML = '<li class="empty">Loading notes‚Ä¶</li>';
      }
      try {
        notesData = await getJSON('/notes');
        updateSummary();
        applyFilters();
      } catch (error) {
        notesList.innerHTML = `<li class="empty" style="color:#f87171">Notes error: ${escapeHTML(error.message)}</li>`;
        showToast(`Notes error: ${error.message}`, 'error');
      }
    }

    async function createNote(event) {
      event.preventDefault();
      const titre = document.getElementById('titre').value.trim();
      const contenu = document.getElementById('contenu').value.trim();
      if (!titre) {
        showToast('Title is required.', 'error');
        return;
      }
      try {
        await fetch('/notes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ titre, contenu })
        });
        event.target.reset();
        showToast('Note created successfully.');
        loadNotes(true);
      } catch (error) {
        showToast(`Unable to create note: ${error.message}`, 'error');
      }
    }

    async function deleteNote(id) {
      if (!confirm('Delete this note permanently?')) return;
      try {
        await fetch(`/notes/${id}`, { method: 'DELETE' });
        showToast('Note deleted.');
        loadNotes(true);
      } catch (error) {
        showToast(`Unable to delete note: ${error.message}`, 'error');
      }
    }

    function openEditor(id) {
      const note = notesData.find(n => n.id === id);
      if (!note) return;
      modalId.value = note.id;
      modalTitre.value = note.titre;
      modalContenu.value = note.contenu || '';
      modal.showModal();
    }

    async function updateNote(event) {
      event.preventDefault();
      const id = modalId.value;
      const titre = modalTitre.value.trim();
      const contenu = modalContenu.value.trim();
      if (!titre) {
        showToast('Title is required.', 'error');
        return;
      }
      try {
        await fetch(`/notes/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ titre, contenu })
        });
        showToast('Note updated.');
        modal.close();
        loadNotes(true);
      } catch (error) {
        showToast(`Unable to update note: ${error.message}`, 'error');
      }
    }

    modalDelete.addEventListener('click', () => {
      const id = modalId.value;
      modal.close();
      deleteNote(id);
    });

    document.getElementById('modalClose').addEventListener('click', () => modal.close());

    document.getElementById('exportNotes').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(notesData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `notes-export-${new Date().toISOString()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('JSON export generated.');
    });

    document.getElementById('refreshNotes').addEventListener('click', () => loadNotes());
    document.getElementById('reloadWeather').addEventListener('click', loadWeather);
    document.getElementById('form').addEventListener('submit', createNote);
    modalForm.addEventListener('submit', updateNote);
    searchInput.addEventListener('input', () => applyFilters());
    sortSelect.addEventListener('change', applyFilters);
    window.addEventListener('keydown', (event) => { if (event.key === 'Escape' && modal.open) modal.close(); });
    if (livePulse) {
      livePulse.addEventListener('click', () => {
        weatherHeadline.classList.remove('headline-pulse');
        void weatherHeadline.offsetWidth;
        weatherHeadline.classList.add('headline-pulse');
        showToast('Adaptive pulse engaged. Weather and notes stay in sync.');
      });
    }

    loadWeather();
    loadNotes();
  </script>
</body>
</html>
